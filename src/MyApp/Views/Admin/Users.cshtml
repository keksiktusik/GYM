@model IEnumerable<MyApp.Models.ApplicationUser>
@{
    ViewData["Title"] = "Panel administratora ‚Äì u≈ºytkownicy";
    var roles = ViewBag.Roles as List<string> ?? new List<string>();
    string selectedRole = ViewBag.SelectedRole;
    string search = ViewBag.Search;
}

@using Microsoft.AspNetCore.Identity
@inject UserManager<MyApp.Models.ApplicationUser> UserManager

<div class="container mt-5">
    <h2 class="text-center mb-4 fw-bold text-pink">üå∏ Panel Administratora ‚Äì U≈ºytkownicy</h2>

    @if (TempData["msg"] != null)
    {
        <div class="alert alert-light text-center shadow-sm border-pink">
            <strong>@TempData["msg"]</strong>
        </div>
    }

    <!-- üîç Wyszukiwanie i filtrowanie -->
    <div class="card shadow-sm border-0 p-4 mb-4">
        <form method="get" asp-action="Users" class="row g-3 align-items-center">
            <div class="col-md-5">
                <input type="text"
                       name="searchString"
                       value="@search"
                       class="form-control border-pink"
                       placeholder="üîç Wyszukaj po adresie e-mail..." />
            </div>

            <div class="col-md-3">
                <select name="roleFilter" class="form-select border-pink">
                    <option value="">Wszystkie role</option>
                    @foreach (var role in roles)
                    {
                        <option value="@role" selected="@(selectedRole == role)">
                            @role
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-2">
                <button class="btn btn-pink w-100" type="submit">Filtruj</button>
            </div>

            <div class="col-md-2 text-end">
                <a class="btn btn-outline-pink w-100" asp-action="Stats">üìä Statystyki</a>
            </div>
        </form>
    </div>

    <!-- üìã Lista u≈ºytkownik√≥w -->
    <div class="card shadow-sm border-0 p-3">
        <table class="table table-striped align-middle text-center">
            <thead style="background-color: #ffe5ec; color: #c9184a;">
                <tr>
                    <th>Email</th>
                    <th>Data utworzenia</th>
                    <th>Potwierdzony e-mail</th>
                    <th>Akcje</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var user in Model)
                {
                    var currentRole = ViewBag.UserRoles[user.Id];

                    <tr>
                        <td>@user.Email</td>
                        <td>@user.CreatedAt.ToShortDateString()</td>
                        <td>@(user.EmailConfirmed ? "‚úÖ Tak" : "‚ùå Nie")</td>

                        <td>
                            <div class="d-flex flex-wrap gap-1 justify-content-center">

                                <!-- Szczeg√≥≈Çy -->
                                <a asp-action="Details"
                                   asp-route-id="@user.Id"
                                   class="btn btn-outline-pink btn-sm">
                                    Szczeg√≥≈Çy
                                </a>

                                <!-- Zmie≈Ñ rolƒô -->
                                <form asp-action="ChangeRole" method="post" class="d-inline">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <select name="roleName"
        class="form-select form-select-sm border-pink"
        style="width:auto;">
    @foreach (var role in roles)
    {
        <option value="@role" selected="@(currentRole == role)">
    @role
</option>

    }
</select>

                                    <button type="submit"
                                            class="btn btn-outline-warning btn-sm">
                                        Zmie≈Ñ
                                    </button>
                                </form>

                                <!-- Zablokuj / Odblokuj -->
                                <form asp-action="ToggleLock" method="post" class="d-inline">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <button type="submit"
                                            class="btn btn-outline-danger btn-sm">
                                        @(user.LockoutEnd != null && user.LockoutEnd > DateTime.UtcNow
                                            ? "Odblokuj"
                                            : "Zablokuj")
                                    </button>
                                </form>

                                <!-- Reset has≈Ça -->
                                <form asp-action="ResetPassword" method="post" class="d-inline">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <button type="submit" class="btn btn-outline-secondary btn-sm">
                                        Resetuj
                                    </button>
                                </form>

                                <!-- Usu≈Ñ -->
                                <form asp-action="DeleteUser" method="post" class="d-inline">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <button type="submit"
                                            class="btn btn-outline-danger btn-sm"
                                            onclick="return confirm('Na pewno chcesz usunƒÖƒá tego u≈ºytkownika?');">
                                        Usu≈Ñ
                                    </button>
                                </form>
                            </div>

                            <!-- Wiadomo≈õƒá -->
                            <form asp-action="SendMessage" method="post" class="mt-2">
                                <input type="hidden" name="userId" value="@user.Id" />
                                <div class="input-group input-group-sm">
                                    <input type="text"
                                           name="message"
                                           class="form-control border-pink"
                                           placeholder="üíå Wpisz wiadomo≈õƒá..." />
                                    <button type="submit" class="btn btn-pink">Wy≈õlij</button>
                                </div>
                            </form>

                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
