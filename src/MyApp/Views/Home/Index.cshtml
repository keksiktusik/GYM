@model MyApp.Models.Person
@{
    ViewData["Title"] = "Panel zdrowia i zajęć";
}

<header>
    <div class="container text-center">
        <h1>System rezerwacji fitness</h1>
        <p class="mb-0">Panel zdrowia – Kalkulator BMI i Twój kalendarz zajęć</p>
    </div>
</header>

<div class="container mt-5">
    <div class="row g-4 align-items-center">

        <!-- BMI -->
        <div class="col-md-6">
            <div class="card p-4 shadow-sm">
                <h3 class="mb-3 text-center text-primary">Kalkulator BMI</h3>

                <form asp-action="Index" method="post">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label asp-for="HeightCm" class="form-label fw-semibold"></label>
                        <input asp-for="HeightCm" class="form-control" type="number" step="0.1" />
                    </div>

                    <div class="mb-3">
                        <label asp-for="WeightKg" class="form-label fw-semibold"></label>
                        <input asp-for="WeightKg" class="form-control" type="number" step="0.1" />
                    </div>

                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg">Oblicz BMI</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- obrazek -->
        <div class="col-md-6 text-center">
            <img src="https://cdn-icons-png.flaticon.com/512/2965/2965879.png"
                 class="img-fluid" style="max-height: 290px;">
        </div>

    </div>

    <!-- KALENDARZ PODGLĄD -->
    <div class="card p-4 mt-5 shadow-sm">
        <h3 class="text-center mb-3 text-primary">Kalendarz Twoich treningów</h3>

        <p class="text-center text-muted">
            ➕ Aby dodać lub edytować trening, przejdź do: <a href="/Training/Calendar" class="fw-bold text-primary">MÓJ KALENDARZ</a>
        </p>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <button id="prev" class="btn btn-outline-secondary btn-sm">← Poprzedni</button>
            <h4 id="monthYear" class="m-0"></h4>
            <button id="next" class="btn btn-outline-secondary btn-sm">Następny →</button>
        </div>

        <table class="table table-bordered text-center align-middle" id="calendar">
            <thead class="table-light">
                <tr>
                    <th>Pn</th>
                    <th>Wt</th>
                    <th>Śr</th>
                    <th>Cz</th>
                    <th>Pt</th>
                    <th>Sob</th>
                    <th>Nd</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
let currentDate = new Date();
let events = [];

// Kolory treningów
const trainingColors = {
    "Cardio": "#74b9ff",
    "Siłowy": "#d63031",
    "Stretching": "#00b894",
    "Zajęcia grupowe": "#e17055",
    "Crossfit": "#6c5ce7",
    "Joga": "#fdcb6e",
    "Pilates": "#00cec9",
    "Inne": "#636e72"
};

// Pobierz eventy
async function loadEvents() {
    const res = await fetch('/Training/GetEvents');
    if (res.ok) {
        events = await res.json();
        renderCalendar(currentDate);
    }
}

function renderCalendar(date) {
    const calendarBody = document.querySelector("#calendar tbody");
    calendarBody.innerHTML = "";

    const year = date.getFullYear();
    const month = date.getMonth();

    document.getElementById("monthYear").textContent =
        date.toLocaleString("pl-PL", { month: "long", year: "numeric" });

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    const startWeekday = (firstDay.getDay() + 6) % 7;
    const totalDays = lastDay.getDate();

    let row = document.createElement("tr");

    // pusty start
    for (let i = 0; i < startWeekday; i++)
        row.appendChild(document.createElement("td"));

    for (let day = 1; day <= totalDays; day++) {

        const cell = document.createElement("td");
        cell.textContent = day;

        const dateString =
            `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        const dayEvents = events.filter(e => e.start.startsWith(dateString));

        if (dayEvents.length > 0) {
            const e = dayEvents[0];
            const color = trainingColors[e.title] || "#0984e3";

            cell.style.backgroundColor = color;
            cell.style.color = "white";
            cell.style.fontWeight = "bold";

            // tooltip
            let tooltip = dayEvents
                .map(ev => `${ev.title} (${ev.start.substring(11, 16)}-${ev.end.substring(11, 16)})`)
                .join("\n");

            cell.title = tooltip;
        }

        row.appendChild(cell);

        if ((startWeekday + day) % 7 === 0) {
            calendarBody.appendChild(row);
            row = document.createElement("tr");
        }
    }

    calendarBody.appendChild(row);
}

document.getElementById("prev").addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar(currentDate);
});

document.getElementById("next").addEventListener("click", () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar(currentDate);
});

loadEvents();
</script>
