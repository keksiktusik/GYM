@{
    ViewData["Title"] = "M√≥j kalendarz";
}

<style>
    .calendar-wrapper {
        display: flex;
        gap: 25px;
    }
    .sidebar {
        width: 280px;
        background: #ffe9f3;
        border-radius: 20px;
        padding: 20px;
        height: fit-content;
        box-shadow: 0 3px 10px rgba(255, 192, 203, 0.3);
    }
    .sidebar h4 {
        color: #d63384;
        font-weight: bold;
        margin-bottom: 15px;
    }
    .stat-box {
        background: white;
        border-radius: 15px;
        padding: 12px 15px;
        margin-bottom: 10px;
        border-left: 5px solid #ff8bb3;
    }
    #calendar {
        flex-grow: 1;
        background: white;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 3px 10px rgba(255, 192, 203, 0.25);
    }
</style>

<div class="container mt-4">

    <h2 class="text-center fw-bold text-pink mb-4">üìÖ M√≥j kalendarz</h2>

    <div class="calendar-wrapper">

        <!-- ‚óÄÔ∏è LEWY PANEL -->
        <div class="sidebar">

            <h4>üìä Statystyki</h4>

            <div class="stat-box">
                üîú Najbli≈ºszy trening:<br />
                <strong id="stat-next-training">≈Åadowanie...</strong>
            </div>

            <div class="stat-box">
                üîÅ Cykliczne plany:<br />
                <strong id="stat-recurring">0</strong>
            </div>

            <div class="stat-box">
                üóì Treningi w tym miesiƒÖcu:<br />
                <strong id="stat-monthly">0</strong>
            </div>

            <h4 class="mt-4">üè∑ Typy trening√≥w</h4>
            <p>‚ù§Ô∏è Cardio</p>
            <p>üí™ Si≈Çowy</p>
            <p>üßò Stretching</p>
            <p>üë• Grupowy</p>
            <p>‚≠ê Inne</p>

        </div>

        <!-- üóì PRAWY PANEL ‚Äì KALENDARZ -->
        <div id="calendar"></div>

    </div>


    <!-- üîÅ LISTA CYKLICZNYCH PLAN√ìW -->
    <div class="container mt-5">
        <h3 class="text-pink fw-bold">üîÅ Twoje cykliczne plany</h3>
        <div id="recurringList">
            <p class="text-muted">≈Åadowanie...</p>
        </div>
    </div>
    <div class="container mt-5">
        <h3 class="text-pink fw-bold">üìä Statystyka aktywno≈õci</h3>
        <canvas id="statsChart" style="max-height: 350px;"></canvas>
    </div>


</div>


<!-- MODAL ‚Äì DODAWANIE TRENINGU -->
<div class="modal fade" id="calendarAddEventModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addEventForm">
        <div class="modal-header">
          <h5 class="modal-title">Dodaj trening</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <div class="mb-2">
            <label class="form-label">Start</label>
            <input type="datetime-local" name="Start" class="form-control" required />
          </div>

          <div class="mb-2">
            <label class="form-label">Koniec</label>
            <input type="datetime-local" name="End" class="form-control" required />
          </div>

          <div class="mb-2">
            <label class="form-label">Typ treningu</label>
            <select name="Title" class="form-select">
              <option value="Cardio">Cardio</option>
              <option value="Si≈Çowy">Si≈Çowy</option>
              <option value="Stretching">Stretching</option>
              <option value="Grupowy">Grupowy</option>
              <option value="Inne">Inne</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Opis</label>
            <textarea name="Description" class="form-control"></textarea>
          </div>

          <div class="form-check my-3">
              <input class="form-check-input" type="checkbox" id="isRecurring" />
              <label class="form-check-label fw-bold">Cykliczny trening</label>
          </div>

          <div id="recurrenceOptions" class="p-3 border rounded" style="display:none; background:#fff0f6;">
              <label class="fw-bold">Czƒôstotliwo≈õƒá:</label>
              <select id="recurrenceInterval" class="form-select">
                  <option value="Daily">Codziennie</option>
                  <option value="Weekly">Co tydzie≈Ñ</option>
                  <option value="Monthly">Co miesiƒÖc</option>
              </select>

              <label class="mt-2 fw-bold">Dni tygodnia:</label>
              <div class="d-flex gap-3 flex-wrap">
                  <label><input type="checkbox" class="weekday" value="Mon"> Pon</label>
                  <label><input type="checkbox" class="weekday" value="Tue"> Wt</label>
                  <label><input type="checkbox" class="weekday" value="Wed"> ≈ör</label>
                  <label><input type="checkbox" class="weekday" value="Thu"> Czw</label>
                  <label><input type="checkbox" class="weekday" value="Fri"> Pt</label>
                  <label><input type="checkbox" class="weekday" value="Sat"> Sob</label>
                  <label><input type="checkbox" class="weekday" value="Sun"> Niedz</label>
              </div>

              <label class="mt-3 fw-bold">Powtarzaj do:</label>
              <input type="date" id="recurrenceEndDate" class="form-control" />
          </div>

        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Zapisz</button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- MODAL ‚Äì EDYCJA -->
<div class="modal fade" id="editEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editEventForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edytuj trening</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="editEventId" name="Id" />

                    <div class="mb-2">
                        <label>Typ treningu</label>
                        <select id="editTitle" name="Title" class="form-select">
                            <option value="Cardio">Cardio</option>
                            <option value="Si≈Çowy">Si≈Çowy</option>
                            <option value="Stretching">Stretching</option>
                            <option value="Grupowy">Grupowy</option>
                            <option value="Inne">Inne</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label>Opis</label>
                        <textarea id="editDescription" name="Description" class="form-control"></textarea>
                    </div>

                    <div class="mb-2">
                        <label>Start</label>
                        <input id="editStart" name="Start" type="datetime-local" class="form-control" />
                    </div>

                    <div class="mb-2">
                        <label>Koniec</label>
                        <input id="editEnd" name="End" type="datetime-local" class="form-control" />
                    </div>

                    <div id="editRecurringInfo" class="mt-3 p-2 border rounded" style="display:none; background:#fff0f6;">
                        <p class="fw-bold text-danger">
                            ‚ö†Ô∏è Ten trening jest czƒô≈õciƒÖ cyklicznego planu.
                            Edytujesz tylko to pojedyncze zdarzenie.
                        </p>
                    </div>

                </div>

                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-danger" onclick="deleteSingleEvent()">Usu≈Ñ</button>
                    <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                </div>

            </form>
        </div>
    </div>
</div>

@section Scripts {

    <!-- FullCalendar dzia≈Ça w tym skrypcie -->
    <script>

        //////////////////////////////////////////////////////////////////////////////
        //                              KALENDARZ
        //////////////////////////////////////////////////////////////////////////////

        document.addEventListener("DOMContentLoaded", function () {

            const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                locale: 'pl',
                timeZone: 'local',
                selectable: true,

                events: '/Training/GetEvents',

                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },

                dateClick(info) {
                    const modal = new bootstrap.Modal(document.getElementById('calendarAddEventModal'));
                    document.querySelector('[name="Start"]').value = info.dateStr + "T08:00";
                    document.querySelector('[name="End"]').value = info.dateStr + "T09:00";
                    modal.show();
                },

                eventClick(info) {
                    openEditModal(info.event);
                }
            });

            calendar.render();


        //////////////////////////////////////////////////////////////////////////////
        //                         EDYCJA WYDARZENIA
        //////////////////////////////////////////////////////////////////////////////

            function openEditModal(event) {

                const modal = new bootstrap.Modal(document.getElementById('editEventModal'));

                document.getElementById("editEventId").value = event.id;
                document.getElementById("editTitle").value = event.title;
                document.getElementById("editDescription").value = event.extendedProps.description || "";
                document.getElementById("editStart").value = event.startStr.substring(0, 16);
                document.getElementById("editEnd").value = event.endStr.substring(0, 16);

                modal.show();
            }

            document.getElementById("editEventForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const formData = Object.fromEntries(new FormData(e.target));

                const res = await fetch("/Training/UpdateEvent", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData)
                });

                if (res.ok) {
                    bootstrap.Modal.getOrCreateInstance(document.getElementById("editEventModal")).hide();
                    calendar.refetchEvents();
                }
            });


        //////////////////////////////////////////////////////////////////////////////
        //                           USUWANIE EVENTU
        //////////////////////////////////////////////////////////////////////////////

            window.deleteSingleEvent = async function () {

                const id = document.getElementById("editEventId").value;

                if (!confirm("Czy na pewno chcesz usunƒÖƒá ten trening?")) return;

                const response = await fetch("/Training/DeleteEvent?id=" + id, {
                    method: "POST"
                });

                const raw = await response.text();
                console.log("DeleteEvent RAW:", raw);

                bootstrap.Modal.getOrCreateInstance(document.getElementById("editEventModal")).hide();
                calendar.refetchEvents();

                alert("‚úî Trening zosta≈Ç usuniƒôty.");
            };


        //////////////////////////////////////////////////////////////////////////////
        //                              STATYSTYKI
        //////////////////////////////////////////////////////////////////////////////

            function loadNextTraining() {
                fetch("/Training/GetNextTraining")
                    .then(r => r.json())
                    .then(data => {
                        const el = document.getElementById("stat-next-training");

                        if (!data.exists) {
                            el.innerHTML = "Brak zaplanowanych trening√≥w.";
                        } else {
                            let start = new Date(data.start);
                            el.innerHTML = `${start.toLocaleDateString("pl-PL")} ‚Ä¢ ${start.toLocaleTimeString("pl-PL", {
                                hour: "2-digit",
                                minute: "2-digit"
                            })} ‚Äî ${data.title}`;
                        }
                    });
            }

            function loadRecurringCount() {
                fetch("/Training/GetRecurringPlans")
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById("stat-recurring").innerText = data.length;
                    });
            }

            function loadMonthlyCount() {
                const today = new Date();
                const y = today.getFullYear();
                const m = today.getMonth() + 1;

                fetch(`/Training/GetMonthlyCount?year=${y}&month=${m}`)
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById("stat-monthly").innerText = data.count;
                    });
            }

            loadNextTraining();
            loadRecurringCount();
            loadMonthlyCount();


        //////////////////////////////////////////////////////////////////////////////
        //                           DODAWANIE WYDARZENIA
        //////////////////////////////////////////////////////////////////////////////

            function fixDate(dateString) {
                if (!dateString) return null;
                return dateString.length === 16 ? dateString + ":00" : dateString;
            }

            document.getElementById("addEventForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const isRecurring = document.getElementById("isRecurring").checked;

                let selectedDays = [];
                document.querySelectorAll(".weekday:checked").forEach(d => selectedDays.push(d.value));

                const endDateRaw = document.getElementById("recurrenceEndDate").value;

                const payload = {
                    Title: this.Title.value,
                    Description: this.Description.value,
                    Start: fixDate(this.Start.value),
                    End: fixDate(this.End.value),
                    IsRecurring: isRecurring,
                    RecurrenceInterval: isRecurring ? document.getElementById("recurrenceInterval").value : null,
                    RecurrenceDays: isRecurring ? selectedDays.join(",") : null,
                    RecurrenceEndDate: isRecurring && endDateRaw ? endDateRaw + "T23:59:59" : null
                };

                console.log("WYSY≈ÅAM PAYLOAD:", payload);

                const res = await fetch("/Training/AddEvent", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const raw = await res.text();
                console.log("RAW RESPONSE:", raw);

                if (!res.ok) {
                    alert("B≈ÇƒÖd serwera:\n" + raw);
                    return;
                }

                const result = JSON.parse(raw);

                if (result.success) {
                    location.reload();
                } else {
                    alert("B≈ÇƒÖd: " + result.error);
                }
            });

        }); // KONIEC DOMContentLoaded


        //////////////////////////////////////////////////////////////////////////////
        //                       POKAZYWANIE OPCJI CYKLICZNYCH
        //////////////////////////////////////////////////////////////////////////////

        document.getElementById("isRecurring").addEventListener("change", function () {
            const box = document.getElementById("recurrenceOptions");
            box.style.display = this.checked ? "block" : "none";

            if (this.checked) {
                const endInput = document.getElementById("recurrenceEndDate");
                if (!endInput.value) {
                    let def = new Date();
                    def.setMonth(def.getMonth() + 1);
                    endInput.value = def.toISOString().split("T")[0];
                }
            }
        });


        //////////////////////////////////////////////////////////////////////////////
        //                       ≈ÅADOWANIE CYKLICZNYCH PLAN√ìW
        //////////////////////////////////////////////////////////////////////////////

        async function loadRecurringPlans() {
            try {
                const res = await fetch("/Training/GetRecurringPlans");
                const plans = await res.json();

                const box = document.getElementById("recurringList");

                if (!plans || plans.length === 0) {
                    box.innerHTML = "<p class='text-muted'>Brak cyklicznych plan√≥w.</p>";
                    return;
                }

                box.innerHTML = plans
                    .map(p => `
                        <div class="p-3 mb-2 border rounded" style="background:white;">
                            <strong>${p.title}</strong><br>
                            üîÅ ${p.recurrenceInterval ?? "-"} (${p.recurrenceDays ?? "-"})<br>
                            üìÖ Do: ${p.recurrenceEndDate ? p.recurrenceEndDate.substring(0,10) : "-"}
                        </div>
                    `)
                    .join("");

            } catch (e) {
                console.error("Recurring plans error:", e);
                document.getElementById("recurringList").innerHTML =
                    "<p class='text-danger'>B≈ÇƒÖd podczas odczytywania danych.</p>";
            }
        }

        loadRecurringPlans();

    </script>

    <!-- ≈ÅADUJEMY CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- WYKRES STATYSTYK -->
    <script>
        async function loadStatsChart() {
            const res = await fetch("/Training/GetCategoryStats");
            const data = await res.json();

            const labels = data.map(x => x.category);
            const values = data.map(x => x.count);

            const ctx = document.getElementById('statsChart').getContext('2d');

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderWidth: 1,
                        backgroundColor: [
                            '#ff8ba7',
                            '#ffb3c6',
                            '#cdeac0',
                            '#a0c4ff',
                            '#bdb2ff'
                        ]
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            labels: {
                                font: { size: 14 }
                            }
                        }
                    }
                }
            });
        }
        loadStatsChart();
    </script>

}

